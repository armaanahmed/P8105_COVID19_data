---
title: "Mental Health"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: spacelab
---

```{r, include = FALSE}
library(tidyverse)
library(modelr)
library(plotly)
library(lubridate)
library(dplyr)
library(readr)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

`%notin%` <- Negate(`%in%`)
```

## Mental Healthcare and the Pandemic

Let's use plotly to illustrate the following:

The proportion of Americans who were not able to get access to mental health care when they needed it, by age (4x4 facet by age)
The proportion of Americans who used pharmaceuticals for their mental health, by age (4x4 facet by age)

4x4 with CIs or one chart with no CI (adding CI might get messy)

Maybe overlay a second set of axes (x2=x1, y2 = COVID count of deaths by end of week) to compare COVID deaths to the mental health status by age?

COVID mortality from Oct 2020 to Oct 2021
```{r}
cm_df = read_csv("Provisional_COVID-19_Death_Counts_by_Week_Ending_Date_and_State.csv") %>% 
  janitor::clean_names() %>%
  mutate(
    start_date = as_date(start_date, format = '%m/%d/%Y'), 
    end_date = as_date(end_date, format = '%m/%d/%Y'),
   ) %>%
   filter(end_date >=("2020-08-31") & end_date <= ("2021-10-11")) %>%
  filter(state == "United States") %>%
  filter(group == "By Week")

cm_anxdep_df = read_csv("Provisional_COVID-19_Death_Counts_by_Week_Ending_Date_and_State.csv") %>%  #Anxiety survey began earlier
  janitor::clean_names() %>%
  mutate(
    start_date = as_date(start_date, format = '%m/%d/%Y'), 
    end_date = as_date(end_date, format = '%m/%d/%Y'),
   ) %>%
   filter(end_date >=("2020-05-05") & end_date <= ("2021-10-11")) %>%
  filter(state == "United States") %>%
  filter(group == "By Week")

z = cm_df %>% 
  ggplot(aes(x = end_date, y = covid_19_deaths)) + 
  geom_line()
ggplotly(z)
```

Cleaning Mental Healthcare data, filtering separately by age and state
```{r}
mh_care_df = read_csv("Mental_Health_Care_in_the_Last_4_Weeks.csv") %>%  
  janitor::clean_names() %>% 
  mutate(
    time_period_start_date = as_date(time_period_start_date, format = '%m/%d/%Y'), 
    time_period_end_date = as_date(time_period_end_date, format = '%m/%d/%Y'),
    state = as_factor(state),
    subgroup = as_factor(subgroup),
    group = as_factor(group),
    indicator = as_factor(indicator)    
   )

mh_age = c("18 - 29 years", "30 - 39 years", "40 - 49 years", "50 - 59 years", "60 - 69 years", "70 - 79 years", "80 years and above")

mh_age_df = mh_care_df %>% filter(subgroup %in% mh_age) %>% 
  #filter(indicator %in% "Took Prescription Medication for Mental Health And/Or Received Counseling or Therapy, Last 4 Weeks")
  #filter(indicator %in% "Took Prescription Medication for Mental Health, Last 4 Weeks")
  filter(indicator %in% "Needed Counseling or Therapy But Did Not Get It, Last 4 Weeks")
  #filter(indicator %in% "Received Counseling or Therapy, Last 4 Weeks")

mh_state = c("By Race/Hispanic ethnicity", "United States", "By Disability status", "By Gender identity", "By Age", "By Sex", "By Education", "National Estimate", "By Presence of Symptoms of Anxiety/Depression")

mh_state_df = mh_care_df %>% filter(group %notin% mh_state) %>% 
  #filter(indicator %in% "Took Prescription Medication for Mental Health And/Or Received Counseling or Therapy, Last 4 Weeks")
  #filter(indicator %in% "Took Prescription Medication for Mental Health, Last 4 Weeks")
  filter(indicator %in% "Needed Counseling or Therapy But Did Not Get It, Last 4 Weeks")
  #filter(indicator %in% "Received Counseling or Therapy, Last 4 Weeks")


```

Cleaning Anxiety Data
```{r}
anxdep_df = read_csv("Indicators_of_Anxiety_or_Depression_Based_on_Reported_Frequency_of_Symptoms_During_Last_7_Days.csv") %>%  
  janitor::clean_names() %>% 
  mutate(
    time_period_start_date = as_date(time_period_start_date, format = '%m/%d/%Y'), 
    time_period_end_date = as_date(time_period_end_date, format = '%m/%d/%Y'),
    state = as_factor(state),
    subgroup = as_factor(subgroup),
    group = as_factor(group),
    indicator = as_factor(indicator)
   )

anxdep_age = c("18 - 29 years", "30 - 39 years", "40 - 49 years", "50 - 59 years", "60 - 69 years", "70 - 79 years", "80 years and above")

anxdep_age_df = anxdep_df %>% filter(subgroup %in% mh_age) %>% 
  #filter(indicator %in% "Symptoms of Anxiety Disorder")
  filter(indicator %in% "Symptoms of Anxiety Disorder or Depressive Disorder")
  #filter(indicator %in% "Symptoms of Depressive Disorder")
  
anxdep_state = c("By Race/Hispanic ethnicity", "United States", "By Disability status", "By Gender identity", "By Age", "By Sex", "By Education", "National Estimate", "By Presence of Symptoms of Anxiety/Depression")

anxdep_state_df = anxdep_df %>% filter(group %notin% anxdep_state) %>% 
  #filter(indicator %in% "Symptoms of Anxiety Disorder")
  filter(indicator %in% "Symptoms of Anxiety Disorder or Depressive Disorder")
  #filter(indicator %in% "Symptoms of Depressive Disorder")
```

## Plotting Age vs ...
```{r}

#Date vs subgroup w/ facet w/ CI
mh_age_df %>%
  ggplot(aes(x = time_period_start_date, y = value, color = subgroup)) + 
  geom_line() + 
  geom_ribbon(aes(ymin=low_ci, ymax=high_ci), linetype=2, alpha=0.1)  + 
  facet_wrap(vars(mh_age_df$subgroup)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Month", y = "% Subgroup affected")

#Date vs subgroup, no facets w/ CI
mh_age_df %>%
  ggplot(aes(x = time_period_start_date, y = value, color = subgroup)) + 
  geom_line() + 
  geom_ribbon(aes(ymin=low_ci, ymax=high_ci), linetype=2, alpha=0.1)  + 
#  facet_wrap(vars(mh_age_df$subgroup)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Month", y = "% Subgroup affected", title = "Healthcare inaccessibility throughout the pandemic by age group ")

# mental health availability w/ facet w/o CI w/COVID mort
ggplot() + 
  geom_line(data = mh_age_df, aes(x = time_period_start_date, y = value, color = subgroup) ) +
  geom_line(data = cm_df, aes(x = end_date, y = covid_19_deaths * 0.001) ) + 
  #geom_ribbon(aes(data = mh_age_df, ymin=low_ci, ymax=high_ci), linetype=2, alpha=0.1)  +
  facet_wrap(vars(subgroup)) +
  scale_y_continuous(breaks = seq(0, 40, 5), sec.axis = sec_axis(trans = ~.*001)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = "Month", y = "% without access to mental health treatment \n COVID mortality in tens of thousands",title = "Healthcare inaccessibility throughout the pandemic by age group ")
#ggplotly(g)

## % Screened for Anxiety or Depression by age
ggplot() + 
  geom_line(data = anxdep_age_df, aes(x = time_period_start_date, y = value, color = subgroup) ) +
  geom_line(data = cm_anxdep_df, aes(x = end_date, y = covid_19_deaths * 0.001) ) + 
  #geom_ribbon(aes(data = mh_age_df, ymin=low_ci, ymax=high_ci), linetype=2, alpha=0.1)  +
  facet_wrap(vars(subgroup)) +
  scale_y_continuous(breaks = seq(0, 80, 10), sec.axis = sec_axis(trans = ~.*001)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = "Month", y = "% Subgroup affected \n COVID mortality in tens of thousands", title = "% Screened for Anxiety or Depression by age")

```


## Top 5 most and least effected states 
```{r}

```

